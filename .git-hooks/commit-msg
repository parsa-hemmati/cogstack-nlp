#!/bin/bash
#
# Commit message format enforcement hook
#
# Enforces commit message format:
#   <type>(<scope>): <short summary>
#
#   [Optional: Agent-generated code]
#
#   Changes:
#   - Bullet list of changes
#
#   Rationale:
#   - Why these changes were made
#
#   Tests:
#   - Test coverage and results
#
#   CONTEXT.md Updates:
#   - What was updated in CONTEXT.md
#
# To install: cp .git-hooks/commit-msg .git/hooks/commit-msg && chmod +x .git/hooks/commit-msg
#

RED='\033[0;31m'
YELLOW='\033[1;33m'
GREEN='\033[0;32m'
NC='\033[0m' # No Color

COMMIT_MSG_FILE=$1
COMMIT_MSG=$(cat "$COMMIT_MSG_FILE")

# Skip if commit message starts with "Merge", "Revert", or other git-generated messages
if echo "$COMMIT_MSG" | grep -qE '^(Merge|Revert|Amend|fixup!|squash!)'; then
    exit 0
fi

# Check for conventional commit format in first line
FIRST_LINE=$(echo "$COMMIT_MSG" | head -n 1)

# Valid types
VALID_TYPES="feat|fix|docs|style|refactor|test|chore|perf|security|build|ci"

# Check format: type(scope): description
if ! echo "$FIRST_LINE" | grep -qE "^($VALID_TYPES)(\(.+\))?: .+"; then
    echo -e "${RED}❌ ERROR: Invalid commit message format${NC}"
    echo ""
    echo "First line must follow format:"
    echo "  <type>(<scope>): <short summary>"
    echo ""
    echo "Valid types:"
    echo "  feat     - New feature"
    echo "  fix      - Bug fix"
    echo "  docs     - Documentation changes"
    echo "  style    - Code style (formatting, semicolons)"
    echo "  refactor - Code restructuring (no functional changes)"
    echo "  test     - Adding/updating tests"
    echo "  chore    - Maintenance (dependencies, tooling)"
    echo "  perf     - Performance improvements"
    echo "  security - Security fixes"
    echo "  build    - Build system changes"
    echo "  ci       - CI/CD changes"
    echo ""
    echo "Examples:"
    echo "  feat(patient-search): add meta-annotation filtering"
    echo "  fix(auth): resolve JWT token expiration issue"
    echo "  docs(claude): update skills section with new workflow"
    echo ""
    echo "Your commit message:"
    echo "$FIRST_LINE"
    echo ""
    echo "See CLAUDE.md 'Commit Message Format' section for details."
    echo ""
    exit 1
fi

# Check summary length (50 characters recommended, 72 max)
SUMMARY=$(echo "$FIRST_LINE" | sed -E 's/^[^:]+: //')
SUMMARY_LENGTH=${#SUMMARY}

if [ "$SUMMARY_LENGTH" -gt 72 ]; then
    echo -e "${RED}❌ ERROR: Commit summary too long ($SUMMARY_LENGTH chars)${NC}"
    echo ""
    echo "Summary should be ≤72 characters (currently: $SUMMARY_LENGTH)"
    echo "Summary: $SUMMARY"
    echo ""
    echo "Try shortening the description or move details to commit body."
    echo ""
    exit 1
fi

if [ "$SUMMARY_LENGTH" -gt 50 ]; then
    echo -e "${YELLOW}⚠️  WARNING: Commit summary is long ($SUMMARY_LENGTH chars)${NC}"
    echo ""
    echo "Recommended: ≤50 characters (currently: $SUMMARY_LENGTH)"
    echo "Summary: $SUMMARY"
    echo ""
    read -p "Continue anyway? (y/N) " -n 1 -r
    echo ""
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        exit 1
    fi
fi

# Check for body (recommended for non-trivial commits)
LINE_COUNT=$(echo "$COMMIT_MSG" | wc -l)

if [ "$LINE_COUNT" -lt 3 ] && ! echo "$FIRST_LINE" | grep -qE "^(docs|style|chore)"; then
    echo -e "${YELLOW}⚠️  WARNING: Commit body is missing${NC}"
    echo ""
    echo "For non-trivial commits, include a body with:"
    echo "  - Changes: What was changed"
    echo "  - Rationale: Why these changes were made"
    echo "  - Tests: Test coverage and results"
    echo "  - CONTEXT.md Updates: What was updated"
    echo ""
    echo "See CLAUDE.md 'Commit Message Format' section for template."
    echo ""
    read -p "Continue anyway? (y/N) " -n 1 -r
    echo ""
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        exit 1
    fi
fi

# Check for CONTEXT.md updates section (if code changes)
if echo "$FIRST_LINE" | grep -qE "^(feat|fix|refactor|perf|security)"; then
    if ! echo "$COMMIT_MSG" | grep -q "CONTEXT.md Updates:"; then
        echo -e "${YELLOW}⚠️  WARNING: Missing CONTEXT.md Updates section${NC}"
        echo ""
        echo "Code changes should document CONTEXT.md updates in commit message:"
        echo ""
        echo "  CONTEXT.md Updates:"
        echo "  - Updated 'Recent Changes' with entry"
        echo "  - [If applicable] Added ADR-XXX for [decision]"
        echo "  - [If applicable] Moved feature to 'Implemented'"
        echo ""
        read -p "Continue anyway? (y/N) " -n 1 -r
        echo ""
        if [[ ! $REPLY =~ ^[Yy]$ ]]; then
            exit 1
        fi
    fi
fi

echo -e "${GREEN}✅ Commit message format valid${NC}"
exit 0
