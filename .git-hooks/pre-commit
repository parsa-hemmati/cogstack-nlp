#!/bin/bash
#
# Pre-commit hook to enforce CONTEXT.md updates
#
# To install: cp .git-hooks/pre-commit .git/hooks/pre-commit && chmod +x .git/hooks/pre-commit
#

RED='\033[0;31m'
YELLOW='\033[1;33m'
GREEN='\033[0;32m'
NC='\033[0m' # No Color

echo -e "${YELLOW}üîç Checking if CONTEXT.md needs updating...${NC}"

# Check if this is the initial commit
if git rev-parse --verify HEAD >/dev/null 2>&1
then
    against=HEAD
else
    # Initial commit: diff against an empty tree object
    against=$(git hash-object -t tree /dev/null)
fi

# Get list of staged files (excluding CONTEXT.md itself and documentation-only changes)
staged_files=$(git diff --cached --name-only --diff-filter=ACM | grep -v '^CONTEXT.md$' | grep -v '^docs/' | grep -v '^\.specify/' | grep -v '\.md$')

# If there are code changes (non-documentation files)
if [ -n "$staged_files" ]; then
    # Check if CONTEXT.md is also being committed
    context_modified=$(git diff --cached --name-only | grep '^CONTEXT.md$')

    if [ -z "$context_modified" ]; then
        echo -e "${RED}‚ùå ERROR: CONTEXT.md must be updated with code changes!${NC}"
        echo ""
        echo -e "${YELLOW}You're committing code changes but CONTEXT.md wasn't modified.${NC}"
        echo ""
        echo "Files being committed:"
        echo "$staged_files" | sed 's/^/  - /'
        echo ""
        echo "Required actions:"
        echo "  1. Update CONTEXT.md with your changes"
        echo "  2. Add relevant information:"
        echo "     - Update 'Recent Changes' section"
        echo "     - Add ADR if architecture changed"
        echo "     - Update 'Implemented Features' or 'In Progress'"
        echo "     - Note any technical debt"
        echo "  3. Stage CONTEXT.md: git add CONTEXT.md"
        echo "  4. Commit again"
        echo ""
        echo "See CONTEXT.md for what to update."
        echo ""
        echo -e "${YELLOW}To bypass this check (NOT recommended):${NC}"
        echo "  git commit --no-verify"
        echo ""
        exit 1
    fi

    # Check if CONTEXT.md actually has meaningful changes (not just date)
    context_diff=$(git diff --cached CONTEXT.md | grep '^+' | grep -v '^+++' | grep -v '^+\*\*Last Updated\*\*' | wc -l)

    if [ "$context_diff" -lt 3 ]; then
        echo -e "${YELLOW}‚ö†Ô∏è  WARNING: CONTEXT.md has minimal changes${NC}"
        echo ""
        echo "CONTEXT.md was modified but changes seem minimal."
        echo "Did you add:"
        echo "  - Entry to 'Recent Changes' section?"
        echo "  - Updated 'Implemented Features' or 'In Progress'?"
        echo "  - ADR if you made an architecture decision?"
        echo ""
        read -p "Continue anyway? (y/N) " -n 1 -r
        echo ""
        if [[ ! $REPLY =~ ^[Yy]$ ]]; then
            echo "Commit aborted. Please update CONTEXT.md with meaningful changes."
            exit 1
        fi
    fi

    echo -e "${GREEN}‚úÖ CONTEXT.md is being updated${NC}"
else
    # Only documentation changes, CONTEXT.md update not required
    echo -e "${GREEN}‚úÖ Documentation-only changes, CONTEXT.md update not required${NC}"
fi

# Additional checks

# Check for console.log or debugger statements
if git diff --cached --name-only | grep -E '\.(js|ts|jsx|tsx|vue)$' >/dev/null; then
    console_logs=$(git diff --cached | grep -E '^\+.*console\.(log|debug|info|warn)' | grep -v '// eslint-disable')
    debuggers=$(git diff --cached | grep -E '^\+.*debugger')

    if [ -n "$console_logs" ] || [ -n "$debuggers" ]; then
        echo -e "${YELLOW}‚ö†Ô∏è  WARNING: Found console.log or debugger statements${NC}"
        echo ""
        if [ -n "$console_logs" ]; then
            echo "Console statements found:"
            echo "$console_logs" | sed 's/^/  /'
        fi
        if [ -n "$debuggers" ]; then
            echo "Debugger statements found:"
            echo "$debuggers" | sed 's/^/  /'
        fi
        echo ""
        read -p "Continue anyway? (y/N) " -n 1 -r
        echo ""
        if [[ ! $REPLY =~ ^[Yy]$ ]]; then
            echo "Commit aborted. Please remove console.log and debugger statements."
            exit 1
        fi
    fi
fi

# Check for TODO comments without associated task
if git diff --cached | grep -E '^\+.*TODO' >/dev/null; then
    echo -e "${YELLOW}‚ö†Ô∏è  WARNING: Found TODO comments${NC}"
    echo ""
    echo "TODO comments found. Consider:"
    echo "  - Creating a task in .specify/tasks/"
    echo "  - Adding to technical debt in CONTEXT.md"
    echo "  - Creating a GitHub issue"
    echo ""
    read -p "Continue anyway? (y/N) " -n 1 -r
    echo ""
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        echo "Commit aborted. Please address TODOs properly."
        exit 1
    fi
fi

echo -e "${GREEN}‚úÖ Pre-commit checks passed${NC}"
echo ""

exit 0
